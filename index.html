<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Al-Quran Al-Karim ‚Äî ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</title>
<meta name="description" content="Lisez et √©coutez le Saint Coran avec traduction"/>
<meta name="theme-color" content="#0a0d14"/>
<link rel="manifest" href="manifest.json"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet"/>
<style>
/* ============================================
   VARIABLES & RESET
   ============================================ */
:root {
  --night: #0a0d14;
  --deep: #0f1520;
  --card: #141b2a;
  --card-hover: #1a2338;
  --gold: #c9a84c;
  --gold-light: #e8c97a;
  --gold-dim: #7a6030;
  --teal: #2a7a6e;
  --teal-light: #3da897;
  --text: #d4c5a0;
  --text-dim: #7a6e5a;
  --white: #f5f0e8;
  --completed: #1a3a2a;
  --completed-border: #2a7a4a;
  --green: #4ade80;
  --radius: 16px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--night);color:var(--text);font-family:'Lato',sans-serif;min-height:100vh;overflow-x:hidden;}
a{text-decoration:none;color:inherit;}
button{cursor:pointer;font-family:inherit;}

/* ============================================
   BACKGROUND
   ============================================ */
.bg-glow{position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:800px;height:600px;background:radial-gradient(ellipse,rgba(201,168,76,.12),transparent 70%);pointer-events:none;z-index:0;}
.bg-pattern{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
.bg-pattern svg{position:absolute;inset:0;width:100%;height:100%;opacity:.04;}

/* ============================================
   LOADING OVERLAY
   ============================================ */
.loading-overlay{position:fixed;inset:0;background:rgba(10,13,20,.97);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:20px;}
.loading-overlay.active{display:flex;}
.spinner{width:44px;height:44px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-family:'Amiri',serif;color:var(--gold);font-size:1.1rem;}

/* ============================================
   HEADER (HOME)
   ============================================ */
.home-header{position:relative;z-index:10;text-align:center;padding:50px 20px 30px;border-bottom:1px solid rgba(201,168,76,.15);}
.moon-icon{font-size:2.8rem;display:block;margin-bottom:10px;animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.arabic-title{font-family:'Amiri',serif;font-size:clamp(1.5rem,4vw,2.4rem);color:var(--gold-light);letter-spacing:.05em;line-height:1.3;margin-bottom:6px;direction:rtl;}
.home-header h1{font-family:'Cinzel',serif;font-size:clamp(1.2rem,3vw,1.8rem);color:var(--white);letter-spacing:.15em;font-weight:600;margin-bottom:4px;text-transform:uppercase;}
.subtitle{color:var(--gold);font-size:.85rem;font-weight:300;letter-spacing:.3em;text-transform:uppercase;margin-bottom:20px;}

/* Progress */
.progress-section{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:16px;}
.progress-label{font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold);letter-spacing:.1em;white-space:nowrap;}
.progress-bar-wrap{width:200px;height:5px;background:rgba(201,168,76,.15);border-radius:99px;overflow:hidden;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold-dim),var(--gold-light));border-radius:99px;transition:width .5s;}
.progress-count{font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold-light);font-weight:600;}

/* ============================================
   TABS
   ============================================ */
.tabs{position:relative;z-index:10;display:flex;justify-content:center;gap:0;padding:16px 20px 0;background:linear-gradient(180deg,rgba(201,168,76,.04),transparent);}
.tab-btn{background:none;border:none;color:var(--text-dim);font-family:'Cinzel',serif;font-size:.8rem;letter-spacing:.12em;text-transform:uppercase;padding:10px 24px;border-bottom:2px solid transparent;transition:all .3s;}
.tab-btn.active{color:var(--gold-light);border-bottom-color:var(--gold);}
.tab-btn:hover{color:var(--gold);}

/* ============================================
   JUZ GRID
   ============================================ */
.grid-section{position:relative;z-index:10;max-width:1100px;margin:0 auto;padding:30px 20px 100px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;}

.juz-card{position:relative;background:var(--card);border:1px solid rgba(201,168,76,.12);border-radius:var(--radius);padding:20px 14px 16px;text-align:center;cursor:pointer;transition:all .3s;overflow:hidden;animation:fadeUp .4s ease both;}
.juz-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);opacity:0;transition:opacity .3s;}
.juz-card:hover{background:var(--card-hover);border-color:rgba(201,168,76,.35);transform:translateY(-3px);box-shadow:0 12px 32px rgba(0,0,0,.4),0 0 16px rgba(201,168,76,.06);}
.juz-card:hover::before{opacity:1;}
.juz-card.completed{background:var(--completed);border-color:var(--completed-border);}
.juz-card.completed::after{content:'‚úì';position:absolute;top:8px;right:10px;color:var(--green);font-size:.9rem;font-weight:700;}

@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.juz-arabic{font-family:'Amiri',serif;font-size:1.1rem;color:var(--gold-light);display:block;margin-bottom:4px;direction:rtl;}
.juz-label{font-family:'Cinzel',serif;font-size:.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.2em;display:block;margin-bottom:6px;}
.juz-number{font-family:'Cinzel',serif;font-size:2rem;font-weight:700;color:var(--white);line-height:1;display:block;margin-bottom:10px;}
.listen-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(135deg,rgba(201,168,76,.18),rgba(201,168,76,.06));border:1px solid rgba(201,168,76,.25);color:var(--gold);font-size:.68rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;padding:5px 10px;border-radius:99px;transition:all .2s;}
.juz-card:hover .listen-badge{background:linear-gradient(135deg,rgba(201,168,76,.3),rgba(201,168,76,.12));border-color:var(--gold);color:var(--gold-light);}

.mark-btn{position:absolute;bottom:0;left:0;right:0;background:rgba(74,222,128,.06);border:none;border-top:1px solid rgba(74,222,128,.12);color:var(--green);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;padding:6px;transition:background .2s;border-radius:0 0 var(--radius) var(--radius);}
.mark-btn:hover{background:rgba(74,222,128,.14);}
.juz-card.completed .mark-btn{background:rgba(74,222,128,.1);color:#86efac;}

/* ============================================
   SURAH LIST
   ============================================ */
.surah-section{display:none;max-width:700px;margin:0 auto;}
.surah-section.active{display:block;}
.search-wrap{padding:0 0 16px;position:relative;}
.search-input{width:100%;background:var(--card);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:12px 16px 12px 42px;color:var(--white);font-size:.95rem;outline:none;transition:border-color .3s;}
.search-input:focus{border-color:var(--gold);}
.search-input::placeholder{color:var(--text-dim);}
.search-icon{position:absolute;left:14px;top:12px;font-size:1.1rem;color:var(--text-dim);}

.surah-item{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--card);border:1px solid rgba(201,168,76,.08);border-radius:12px;margin-bottom:8px;cursor:pointer;transition:all .2s;}
.surah-item:hover{background:var(--card-hover);border-color:rgba(201,168,76,.25);transform:translateX(4px);}
.surah-num{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:10px;font-family:'Cinzel',serif;font-size:.85rem;color:var(--gold);font-weight:600;flex-shrink:0;}
.surah-info{flex:1;min-width:0;}
.surah-name-ar{font-family:'Amiri',serif;font-size:1.15rem;color:var(--gold-light);direction:rtl;text-align:right;}
.surah-name-en{font-size:.78rem;color:var(--text-dim);margin-top:2px;}
.surah-meta{text-align:right;flex-shrink:0;}
.surah-ayah-count{font-size:.7rem;color:var(--text-dim);}
.surah-type{font-size:.6rem;color:var(--teal-light);text-transform:uppercase;letter-spacing:.08em;}

/* ============================================
   READER VIEW
   ============================================ */
#view-reader{display:none;position:relative;z-index:10;}

.reader-header{position:sticky;top:0;z-index:50;background:var(--deep);border-bottom:1px solid rgba(201,168,76,.2);display:flex;align-items:center;padding:12px 16px;gap:12px;backdrop-filter:blur(12px);}
.back-btn{background:none;border:1px solid rgba(201,168,76,.2);color:var(--gold);font-size:.85rem;padding:8px 14px;border-radius:10px;display:flex;align-items:center;gap:6px;transition:all .2s;flex-shrink:0;}
.back-btn:hover{border-color:var(--gold);background:rgba(201,168,76,.1);}
.reader-title{flex:1;text-align:center;font-family:'Amiri',serif;font-size:1.15rem;color:var(--gold-light);direction:rtl;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reader-actions{display:flex;gap:6px;flex-shrink:0;}
.reader-actions button{background:none;border:1px solid rgba(201,168,76,.15);color:var(--gold);width:36px;height:36px;border-radius:10px;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.reader-actions button:hover{border-color:var(--gold);background:rgba(201,168,76,.1);}
.reader-actions button.active{background:rgba(201,168,76,.2);border-color:var(--gold);}

.reader-content{max-width:800px;margin:0 auto;padding:20px 16px 180px;}

/* Surah Header in Reader */
.surah-banner{text-align:center;padding:28px 20px;margin:16px 0 24px;background:linear-gradient(180deg,rgba(201,168,76,.07),rgba(201,168,76,.02));border:1px solid rgba(201,168,76,.18);border-radius:var(--radius);position:relative;}
.surah-banner::before,.surah-banner::after{content:'‚ú¶';position:absolute;top:50%;color:rgba(201,168,76,.25);font-size:.8rem;}
.surah-banner::before{left:16px;transform:translateY(-50%);}
.surah-banner::after{right:16px;transform:translateY(-50%);}
.surah-banner-name{font-family:'Amiri',serif;font-size:1.8rem;color:var(--gold-light);direction:rtl;margin-bottom:6px;}
.surah-banner-detail{font-size:.75rem;color:var(--text-dim);letter-spacing:.1em;}

/* Bismillah */
.bismillah{text-align:center;font-family:'Amiri',serif;font-size:1.5rem;color:var(--gold);direction:rtl;padding:16px 0 24px;opacity:.9;}

/* Verses */
.verse{padding:18px 16px;border-bottom:1px solid rgba(201,168,76,.06);transition:background .3s;cursor:pointer;border-radius:8px;margin-bottom:2px;}
.verse:hover{background:rgba(201,168,76,.04);}
.verse.playing{background:rgba(201,168,76,.1);border-left:3px solid var(--gold);border-radius:0 8px 8px 0;}
.verse-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.verse-num-badge{display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:34px;padding:0 8px;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);border-radius:50%;font-family:'Amiri',serif;font-size:.85rem;color:var(--gold);}
.verse-play-btn{background:none;border:none;color:var(--text-dim);font-size:.9rem;padding:6px;border-radius:50%;transition:all .2s;}
.verse-play-btn:hover{color:var(--gold);background:rgba(201,168,76,.1);}
.verse-arabic{font-family:'Amiri',serif;font-size:clamp(1.3rem,3.5vw,1.7rem);line-height:2.4;color:var(--white);text-align:right;direction:rtl;margin-bottom:10px;word-spacing:4px;}
.verse-translation{font-size:.9rem;color:var(--text-dim);line-height:1.7;padding-left:16px;border-left:2px solid rgba(201,168,76,.12);margin-top:8px;}

/* ============================================
   AUDIO PLAYER (Sticky Bottom)
   ============================================ */
.audio-player{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,var(--deep),#080b11);border-top:1px solid rgba(201,168,76,.2);padding:10px 16px 14px;z-index:100;display:none;backdrop-filter:blur(12px);}
.audio-player.visible{display:block;}

.player-progress{width:100%;height:3px;background:rgba(201,168,76,.15);border-radius:99px;margin-bottom:10px;cursor:pointer;position:relative;}
.player-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold-dim),var(--gold));border-radius:99px;transition:width .3s;width:0%;}

.player-main{display:flex;align-items:center;gap:12px;}
.player-info{flex:1;min-width:0;}
.player-surah-name{font-family:'Amiri',serif;color:var(--gold-light);font-size:.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.player-ayah-num{color:var(--text-dim);font-size:.7rem;margin-top:1px;}
.player-controls{display:flex;align-items:center;gap:4px;}
.player-controls button{background:none;border:none;color:var(--gold);font-size:1.1rem;width:38px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s;}
.player-controls button:hover{background:rgba(201,168,76,.12);}
.play-main-btn{background:linear-gradient(135deg,var(--gold-dim),var(--gold))!important;color:var(--night)!important;width:44px!important;height:44px!important;font-size:1.2rem!important;}
.play-main-btn:hover{filter:brightness(1.15);}
.player-extra{display:flex;align-items:center;gap:4px;}
.player-extra button{background:none;border:none;color:var(--text-dim);font-size:.85rem;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s;}
.player-extra button:hover{color:var(--gold);}
.player-extra button.active{color:var(--gold);}

/* ============================================
   SETTINGS PANEL
   ============================================ */
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
.settings-overlay.active{display:flex;}
.settings-panel{background:var(--deep);border:1px solid rgba(201,168,76,.2);border-radius:24px 24px 0 0;padding:24px 20px 40px;width:100%;max-width:500px;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.settings-handle{width:40px;height:4px;background:rgba(201,168,76,.3);border-radius:99px;margin:0 auto 20px;}
.settings-title{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold-light);text-align:center;margin-bottom:20px;letter-spacing:.1em;}
.setting-group{margin-bottom:18px;}
.setting-label{font-size:.75rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;display:block;}
.setting-select{width:100%;background:var(--card);border:1px solid rgba(201,168,76,.2);border-radius:10px;padding:12px 14px;color:var(--white);font-size:.9rem;outline:none;appearance:none;cursor:pointer;}
.setting-select:focus{border-color:var(--gold);}
.setting-select option{background:var(--deep);color:var(--white);}
.settings-close{display:block;width:100%;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);color:var(--gold);font-family:'Cinzel',serif;font-size:.85rem;padding:12px;border-radius:12px;margin-top:10px;letter-spacing:.1em;transition:all .2s;}
.settings-close:hover{background:rgba(201,168,76,.2);}

/* ============================================
   FOOTER
   ============================================ */
footer{position:relative;z-index:10;text-align:center;padding:24px 20px 36px;border-top:1px solid rgba(201,168,76,.08);}
.footer-dua{font-family:'Amiri',serif;font-size:1rem;color:var(--gold);direction:rtl;margin-bottom:10px;line-height:1.8;}
.footer-credit{font-size:.75rem;color:var(--text-dim);letter-spacing:.05em;}
.footer-credit a{color:var(--teal-light);}
.footer-credit a:hover{color:var(--gold);}

/* ============================================
   RESPONSIVE
   ============================================ */
@media(max-width:480px){
  .grid{grid-template-columns:repeat(3,1fr);gap:10px;}
  .juz-number{font-size:1.6rem;}
  .juz-arabic{font-size:.9rem;}
  .listen-badge{font-size:.6rem;padding:4px 8px;}
  .verse-arabic{font-size:1.25rem;line-height:2.2;}
  .reader-header{padding:10px 12px;}
  .player-main{gap:8px;}
}
</style>
</head>
<body>

<!-- Background -->
<div class="bg-glow"></div>
<div class="bg-pattern">
  <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice">
    <defs><pattern id="geo" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
      <polygon points="20,2 38,11 38,29 20,38 2,29 2,11" fill="none" stroke="#c9a84c" stroke-width="0.5"/>
      <polygon points="20,8 32,14 32,26 20,32 8,26 8,14" fill="none" stroke="#c9a84c" stroke-width="0.3"/>
    </pattern></defs>
    <rect width="200" height="200" fill="url(#geo)"/>
  </svg>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ...</div>
</div>

<!-- ============================================
     VIEW: HOME
     ============================================ -->
<div id="view-home">
  <header class="home-header">
    <span class="moon-icon">üåô</span>
    <div class="arabic-title">ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
    <h1>Al-Quran Al-Karim</h1>
    <div class="subtitle">Le Noble Coran</div>
    <div class="progress-section">
      <span class="progress-label">Progression</span>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progressFill"></div>
      </div>
      <span class="progress-count" id="progressCount">0 / 30</span>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('juz')">Par Juz</button>
    <button class="tab-btn" onclick="switchTab('surah')">Par Sourate</button>
  </div>

  <!-- Juz Grid -->
  <div class="grid-section" id="juz-section">
    <div class="grid" id="juz-grid"></div>
  </div>

  <!-- Surah List -->
  <div class="grid-section">
    <div class="surah-section" id="surah-section">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input class="search-input" type="text" placeholder="Rechercher une sourate..." oninput="filterSurahs(this.value)"/>
      </div>
      <div id="surah-list"></div>
    </div>
  </div>

  <footer>
    <div class="footer-dua">ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿßÿ¨ŸíÿπŸéŸÑŸê ÿßŸÑŸíŸÇŸèÿ±Ÿíÿ¢ŸÜŸé ÿ±Ÿéÿ®ŸêŸäÿπŸé ŸÇŸéŸÑŸíÿ®ŸêŸä ü§≤</div>
    <div class="footer-credit">
      Made with ‚ù§Ô∏è by <a href="https://github.com/" target="_blank">Mouhamadou</a> ¬∑ Open Source
    </div>
  </footer>
</div>

<!-- ============================================
     VIEW: READER
     ============================================ -->
<div id="view-reader">
  <div class="reader-header">
    <button class="back-btn" onclick="goHome()">‚Üê Retour</button>
    <div class="reader-title" id="reader-title"></div>
    <div class="reader-actions">
      <button onclick="toggleTranslation()" id="btn-trans" title="Traduction">üåç</button>
      <button onclick="openSettings()" title="Param√®tres">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="reader-content" id="reader-content"></div>
</div>

<!-- Audio Player -->
<div class="audio-player" id="audio-player">
  <div class="player-progress" id="player-progress" onclick="seekAudio(event)">
    <div class="player-progress-fill" id="player-progress-fill"></div>
  </div>
  <div class="player-main">
    <div class="player-info">
      <div class="player-surah-name" id="player-surah"></div>
      <div class="player-ayah-num" id="player-ayah"></div>
    </div>
    <div class="player-controls">
      <button onclick="prevAyah()" title="Pr√©c√©dent">‚èÆ</button>
      <button class="play-main-btn" onclick="togglePlay()" id="play-btn" title="Lecture">‚ñ∂</button>
      <button onclick="nextAyah()" title="Suivant">‚è≠</button>
    </div>
    <div class="player-extra">
      <button onclick="toggleRepeat()" id="btn-repeat" title="R√©p√©ter le verset">üîÅ</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="settings-overlay" id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel">
    <div class="settings-handle"></div>
    <div class="settings-title">‚öôÔ∏è Param√®tres</div>

    <div class="setting-group">
      <label class="setting-label">R√©citateur</label>
      <select class="setting-select" id="select-reciter" onchange="changeReciter(this.value)">
        <option value="ar.alafasy">Mishary Rashid Alafasy</option>
        <option value="ar.abdulbasitmurattal">Abdul Basit (Murattal)</option>
        <option value="ar.abdurrahmaansudais">Abdurrahman As-Sudais</option>
        <option value="ar.hudhaify">Ali Al-Hudhaify</option>
        <option value="ar.minshawimujawwad">El-Minshawi (Mujawwad)</option>
      </select>
    </div>

    <div class="setting-group">
      <label class="setting-label">Traduction</label>
      <select class="setting-select" id="select-translation" onchange="changeTranslation(this.value)">
        <option value="fr.hamidullah">Fran√ßais ‚Äî Hamidullah</option>
        <option value="en.sahih">English ‚Äî Sahih International</option>
        <option value="en.pickthall">English ‚Äî Pickthall</option>
        <option value="tr.ates">T√ºrk√ße ‚Äî S√ºleyman Ate≈ü</option>
        <option value="es.cortes">Espa√±ol ‚Äî Julio Cortes</option>
      </select>
    </div>

    <button class="settings-close" onclick="closeSettings()">Fermer</button>
  </div>
</div>

<script>
/* ============================================
   APP STATE
   ============================================ */
const App = {
  view: 'home',
  ayahs: [],
  translations: [],
  currentIdx: 0,
  isPlaying: false,
  repeatOne: false,
  showTranslation: true,
  reciter: localStorage.getItem('q_reciter') || 'ar.alafasy',
  transEdition: localStorage.getItem('q_trans') || 'fr.hamidullah',
  completed: JSON.parse(localStorage.getItem('q_done') || '[]'),
  surahList: null,
  audio: new Audio(),
  cache: {}
};

const API = 'https://api.alquran.cloud/v1';
const AUDIO_CDN = 'https://cdn.islamic.network/quran/audio/128';

const JUZ_AR = [
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ£ŸàŸÑ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÜŸä','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ±ÿßÿ®ÿπ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿÆÿßŸÖÿ≥',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿØÿ≥','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿ®ÿπ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÖŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ™ÿßÿ≥ÿπ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπÿßÿ¥ÿ±',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≠ÿßÿØŸä ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÜŸä ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ±ÿßÿ®ÿπ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿÆÿßŸÖÿ≥ ÿπÿ¥ÿ±',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿØÿ≥ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿ®ÿπ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÖŸÜ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ™ÿßÿ≥ÿπ ÿπÿ¥ÿ±','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπÿ¥ÿ±ŸàŸÜ',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≠ÿßÿØŸä ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÜŸä ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÑÿ´ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ±ÿßÿ®ÿπ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿÆÿßŸÖÿ≥ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ',
  'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿØÿ≥ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ÿßÿ®ÿπ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ÿßŸÖŸÜ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ™ÿßÿ≥ÿπ ŸàÿßŸÑÿπÿ¥ÿ±ŸàŸÜ','ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ´ŸÑÿßÿ´ŸàŸÜ'
];

/* ============================================
   UTILITIES
   ============================================ */
function toAr(n){const d='Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©';return String(n).split('').map(c=>d[+c]||c).join('');}

function showLoading(){document.getElementById('loading').classList.add('active');}
function hideLoading(){document.getElementById('loading').classList.remove('active');}

function saveCompleted(){
  localStorage.setItem('q_done',JSON.stringify(App.completed));
  updateProgress();
}

function updateProgress(){
  const n=App.completed.length;
  document.getElementById('progressFill').style.width=(n/30*100)+'%';
  document.getElementById('progressCount').textContent=n+' / 30';
}

/* ============================================
   API ‚Äî FETCH DATA
   ============================================ */
async function fetchData(endpoint){
  const res=await fetch(API+endpoint);
  if(!res.ok)throw new Error('API Error');
  const json=await res.json();
  return json.data;
}

async function loadJuz(num){
  const key='juz_'+num+'_'+App.transEdition;
  if(App.cache[key])return App.cache[key];
  // Try localStorage
  try{const c=localStorage.getItem(key);if(c){App.cache[key]=JSON.parse(c);return App.cache[key];}}catch(e){}
  showLoading();
  try{
    const[ar,tr]=await Promise.all([
      fetchData('/juz/'+num+'/quran-uthmani'),
      fetchData('/juz/'+num+'/'+App.transEdition)
    ]);
    const data={ayahs:ar.ayahs,translations:tr.ayahs};
    App.cache[key]=data;
    try{localStorage.setItem(key,JSON.stringify(data));}catch(e){}
    return data;
  }finally{hideLoading();}
}

async function loadSurah(num){
  const key='surah_'+num+'_'+App.transEdition;
  if(App.cache[key])return App.cache[key];
  try{const c=localStorage.getItem(key);if(c){App.cache[key]=JSON.parse(c);return App.cache[key];}}catch(e){}
  showLoading();
  try{
    const[ar,tr]=await Promise.all([
      fetchData('/surah/'+num+'/quran-uthmani'),
      fetchData('/surah/'+num+'/'+App.transEdition)
    ]);
    const data={ayahs:ar.ayahs,translations:tr.ayahs,surah:ar};
    App.cache[key]=data;
    try{localStorage.setItem(key,JSON.stringify(data));}catch(e){}
    return data;
  }finally{hideLoading();}
}

async function loadSurahList(){
  if(App.surahList)return App.surahList;
  try{const c=localStorage.getItem('surah_list');if(c){App.surahList=JSON.parse(c);return App.surahList;}}catch(e){}
  const data=await fetchData('/surah');
  App.surahList=data;
  try{localStorage.setItem('surah_list',JSON.stringify(data));}catch(e){}
  return data;
}

/* ============================================
   AUDIO PLAYER
   ============================================ */
function audioUrl(ayahNum){
  return AUDIO_CDN+'/'+App.reciter+'/'+ayahNum+'.mp3';
}

function playAyah(idx){
  if(idx<0||idx>=App.ayahs.length)return;
  App.currentIdx=idx;
  const a=App.ayahs[idx];
  App.audio.src=audioUrl(a.number);
  App.audio.play().catch(()=>{});
  App.isPlaying=true;
  highlightVerse(idx);
  updatePlayerUI();
  showPlayer();
}

function togglePlay(){
  if(!App.ayahs.length)return;
  if(App.isPlaying){
    App.audio.pause();
    App.isPlaying=false;
  }else{
    if(!App.audio.src||App.audio.src===''){
      playAyah(0);return;
    }
    App.audio.play().catch(()=>{});
    App.isPlaying=true;
  }
  updatePlayerUI();
}

function nextAyah(){if(App.currentIdx<App.ayahs.length-1)playAyah(App.currentIdx+1);}
function prevAyah(){if(App.currentIdx>0)playAyah(App.currentIdx-1);}

function toggleRepeat(){
  App.repeatOne=!App.repeatOne;
  document.getElementById('btn-repeat').classList.toggle('active',App.repeatOne);
}

App.audio.addEventListener('ended',()=>{
  if(App.repeatOne){
    App.audio.currentTime=0;
    App.audio.play().catch(()=>{});
  }else if(App.currentIdx<App.ayahs.length-1){
    playAyah(App.currentIdx+1);
  }else{
    App.isPlaying=false;
    updatePlayerUI();
  }
});

App.audio.addEventListener('timeupdate',()=>{
  if(App.audio.duration){
    const pct=(App.audio.currentTime/App.audio.duration)*100;
    document.getElementById('player-progress-fill').style.width=pct+'%';
  }
});

function seekAudio(e){
  const bar=document.getElementById('player-progress');
  const pct=e.offsetX/bar.offsetWidth;
  if(App.audio.duration)App.audio.currentTime=pct*App.audio.duration;
}

function showPlayer(){document.getElementById('audio-player').classList.add('visible');}
function hidePlayer(){document.getElementById('audio-player').classList.remove('visible');}

function updatePlayerUI(){
  document.getElementById('play-btn').textContent=App.isPlaying?'‚è∏':'‚ñ∂';
  if(App.ayahs.length&&App.ayahs[App.currentIdx]){
    const a=App.ayahs[App.currentIdx];
    document.getElementById('player-surah').textContent=a.surah.name;
    document.getElementById('player-ayah').textContent='Verset '+a.numberInSurah+' / '+a.surah.numberOfAyahs;
  }
}

function highlightVerse(idx){
  document.querySelectorAll('.verse.playing').forEach(el=>el.classList.remove('playing'));
  const el=document.getElementById('v-'+idx);
  if(el){
    el.classList.add('playing');
    el.scrollIntoView({behavior:'smooth',block:'center'});
  }
}

/* ============================================
   NAVIGATION
   ============================================ */
function goHome(){
  App.audio.pause();
  App.isPlaying=false;
  App.view='home';
  document.getElementById('view-home').style.display='';
  document.getElementById('view-reader').style.display='none';
  hidePlayer();
  window.scrollTo(0,0);
}

async function openJuz(num){
  App.view='reader';
  document.getElementById('view-home').style.display='none';
  document.getElementById('view-reader').style.display='';
  document.getElementById('reader-title').textContent=JUZ_AR[num-1];
  document.getElementById('reader-content').innerHTML='<div style="text-align:center;padding:60px 20px;color:var(--text-dim)">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';
  window.scrollTo(0,0);
  try{
    const data=await loadJuz(num);
    App.ayahs=data.ayahs;
    App.translations=data.translations;
    App.currentIdx=0;
    renderReader();
  }catch(err){
    document.getElementById('reader-content').innerHTML='<div style="text-align:center;padding:60px 20px;color:#e74c3c;">‚ùå Erreur de chargement<br><small>V√©rifiez votre connexion internet</small><br><br><button onclick="openJuz('+num+')" style="background:var(--gold);color:var(--night);border:none;padding:10px 24px;border-radius:8px;cursor:pointer;">R√©essayer</button></div>';
  }
}

async function openSurah(num){
  App.view='reader';
  document.getElementById('view-home').style.display='none';
  document.getElementById('view-reader').style.display='';
  document.getElementById('reader-content').innerHTML='<div style="text-align:center;padding:60px 20px;color:var(--text-dim)">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';
  window.scrollTo(0,0);
  try{
    const data=await loadSurah(num);
    App.ayahs=data.ayahs;
    App.translations=data.translations;
    App.currentIdx=0;
    document.getElementById('reader-title').textContent=data.ayahs[0].surah.name;
    renderReader();
  }catch(err){
    document.getElementById('reader-content').innerHTML='<div style="text-align:center;padding:60px 20px;color:#e74c3c;">‚ùå Erreur de chargement<br><small>V√©rifiez votre connexion internet</small><br><br><button onclick="openSurah('+num+')" style="background:var(--gold);color:var(--night);border:none;padding:10px 24px;border-radius:8px;cursor:pointer;">R√©essayer</button></div>';
  }
}

/* ============================================
   RENDER: HOME ‚Äî JUZ GRID
   ============================================ */
function renderJuzGrid(){
  const grid=document.getElementById('juz-grid');
  grid.innerHTML='';
  for(let i=1;i<=30;i++){
    const done=App.completed.includes(i);
    const card=document.createElement('div');
    card.className='juz-card'+(done?' completed':'');
    card.style.animationDelay=(Math.min(i,15)*0.03)+'s';
    card.innerHTML=`
      <span class="juz-arabic">${JUZ_AR[i-1].split(' ').slice(0,2).join(' ')}</span>
      <span class="juz-label">Juz</span>
      <span class="juz-number">${String(i).padStart(2,'0')}</span>
      <span class="listen-badge">üìñ Lire & √âcouter</span>
      <button class="mark-btn" onclick="event.stopPropagation();toggleDone(${i})">${done?'‚úì Termin√©':'+ Marquer lu'}</button>
    `;
    card.addEventListener('click',()=>openJuz(i));
    grid.appendChild(card);
  }
  updateProgress();
}

function toggleDone(num){
  const idx=App.completed.indexOf(num);
  if(idx===-1)App.completed.push(num);else App.completed.splice(idx,1);
  saveCompleted();
  renderJuzGrid();
}

/* ============================================
   RENDER: HOME ‚Äî SURAH LIST
   ============================================ */
async function renderSurahList(){
  const container=document.getElementById('surah-list');
  if(container.children.length>0)return; // Already rendered
  try{
    const surahs=await loadSurahList();
    container.innerHTML='';
    surahs.forEach(s=>{
      const item=document.createElement('div');
      item.className='surah-item';
      item.dataset.search=(s.name+' '+s.englishName+' '+s.englishNameTranslation+' '+s.number).toLowerCase();
      item.innerHTML=`
        <div class="surah-num">${s.number}</div>
        <div class="surah-info">
          <div class="surah-name-ar">${s.name}</div>
          <div class="surah-name-en">${s.englishName} ‚Äî ${s.englishNameTranslation}</div>
        </div>
        <div class="surah-meta">
          <div class="surah-ayah-count">${s.numberOfAyahs} versets</div>
          <div class="surah-type">${s.revelationType==='Meccan'?'Mecquoise':'M√©dinoise'}</div>
        </div>
      `;
      item.addEventListener('click',()=>openSurah(s.number));
      container.appendChild(item);
    });
  }catch(err){
    container.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-dim)">Erreur de chargement des sourates</div>';
  }
}

function filterSurahs(query){
  const q=query.toLowerCase().trim();
  document.querySelectorAll('.surah-item').forEach(item=>{
    item.style.display=(!q||item.dataset.search.includes(q))?'':'none';
  });
}

/* ============================================
   RENDER: READER
   ============================================ */
function renderReader(){
  const content=document.getElementById('reader-content');
  content.innerHTML='';
  let curSurah=null;
  const BISMILLAH='ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê';

  App.ayahs.forEach((a,idx)=>{
    // Surah header
    if(a.surah.number!==curSurah){
      curSurah=a.surah.number;
      const banner=document.createElement('div');
      banner.className='surah-banner';
      banner.innerHTML=`
        <div class="surah-banner-name">${a.surah.name}</div>
        <div class="surah-banner-detail">${a.surah.englishName} ‚Äî ${a.surah.numberOfAyahs} versets ‚Äî ${a.surah.revelationType==='Meccan'?'Mecquoise':'M√©dinoise'}</div>
      `;
      content.appendChild(banner);
      // Bismillah (not for At-Tawbah #9, Al-Fatiha has it as verse 1)
      if(a.surah.number!==9&&a.surah.number!==1){
        const bis=document.createElement('div');
        bis.className='bismillah';
        bis.textContent=BISMILLAH;
        content.appendChild(bis);
      }
    }

    // Verse
    const verse=document.createElement('div');
    verse.className='verse';
    verse.id='v-'+idx;
    verse.innerHTML=`
      <div class="verse-head">
        <span class="verse-num-badge">${toAr(a.numberInSurah)}</span>
        <button class="verse-play-btn" onclick="event.stopPropagation();playAyah(${idx})" title="√âcouter ce verset">‚ñ∂</button>
      </div>
      <div class="verse-arabic">${a.text}</div>
      ${App.showTranslation&&App.translations[idx]?'<div class="verse-translation">'+App.translations[idx].text+'</div>':''}
    `;
    verse.addEventListener('click',()=>playAyah(idx));
    content.appendChild(verse);
  });

  // Padding at bottom for player
  const spacer=document.createElement('div');
  spacer.style.height='80px';
  content.appendChild(spacer);

  showPlayer();
  updatePlayerUI();
}

/* ============================================
   TABS
   ============================================ */
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  if(tab==='juz'){
    document.getElementById('juz-section').style.display='';
    document.getElementById('surah-section').classList.remove('active');
  }else{
    document.getElementById('juz-section').style.display='none';
    document.getElementById('surah-section').classList.add('active');
    renderSurahList();
  }
}

/* ============================================
   TRANSLATION TOGGLE
   ============================================ */
function toggleTranslation(){
  App.showTranslation=!App.showTranslation;
  document.getElementById('btn-trans').classList.toggle('active',App.showTranslation);
  if(App.view==='reader')renderReader();
}

/* ============================================
   SETTINGS
   ============================================ */
function openSettings(){document.getElementById('settings-overlay').classList.add('active');}
function closeSettings(){document.getElementById('settings-overlay').classList.remove('active');}

function changeReciter(val){
  App.reciter=val;
  localStorage.setItem('q_reciter',val);
  // If playing, restart current ayah with new reciter
  if(App.isPlaying)playAyah(App.currentIdx);
}

function changeTranslation(val){
  App.transEdition=val;
  localStorage.setItem('q_trans',val);
  App.cache={}; // Clear cache for new translation
  // Reload if in reader
  if(App.view==='reader'&&App.ayahs.length){
    const surahNum=App.ayahs[0].surah?App.ayahs[0].surah.number:null;
    // Re-fetch with new translation
    document.getElementById('reader-content').innerHTML='<div style="text-align:center;padding:60px;color:var(--text-dim)">Changement de traduction...</div>';
    // Determine if we were viewing a Juz or Surah ‚Äî simplified: refetch
  }
}

/* ============================================
   INIT
   ============================================ */
(function init(){
  // Restore settings in selects
  document.getElementById('select-reciter').value=App.reciter;
  document.getElementById('select-translation').value=App.transEdition;
  document.getElementById('btn-trans').classList.toggle('active',App.showTranslation);

  renderJuzGrid();
})();

/* ============================================
   SERVICE WORKER (PWA)
   ============================================ */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>
